# 密码找回功能页面流程设计与实现计划

## 1. 需求分析
根据用户需求，设计一个完整的密码找回功能，包括用户名验证、安全问题验证和密码重置三个阶段，确保安全性和良好的用户体验。

## 2. 技术栈
- 前端：HTML、CSS、JavaScript
- 后端：Node.js + Express
- 数据库：SQLite
- 安全：bcrypt加密、模糊错误提示

## 3. 实现方案

### 3.1 页面设计

#### 3.1.1 密码找回主页面（forgot-password.html）
- 包含三个阶段的表单，通过JavaScript控制显示/隐藏
- 进度指示器，显示当前所处阶段
- 响应式设计，适配移动端

#### 3.1.2 页面结构
```html
<div class="forgot-password-container">
    <div class="forgot-password-box">
        <h2>密码找回</h2>
        
        <!-- 进度指示器 -->
        <div class="progress-indicator">
            <div class="progress-step active">1. 验证用户名</div>
            <div class="progress-step">2. 验证安全问题</div>
            <div class="progress-step">3. 重置密码</div>
        </div>
        
        <!-- 阶段1：用户名验证 -->
        <div id="step1" class="step active">
            <form id="username-form" onsubmit="return validateUsername()">
                <div class="input-group">
                    <label for="username">用户名<span class="required">*</span></label>
                    <input type="text" id="username" name="username" placeholder="请输入用户名" required>
                    <div class="error-message" id="usernameError"></div>
                </div>
                <div class="button-group">
                    <button type="button" class="cancel-button" onclick="cancelReset()">取消</button>
                    <button type="submit" class="next-button">下一步</button>
                </div>
            </form>
        </div>
        
        <!-- 阶段2：安全问题验证 -->
        <div id="step2" class="step">
            <form id="security-form" onsubmit="return validateSecurityAnswer()">
                <div class="input-group">
                    <label for="securityQuestion">安全问题<span class="required">*</span></label>
                    <div id="securityQuestion" class="security-question"></div>
                </div>
                <div class="input-group">
                    <label for="securityAnswer">答案<span class="required">*</span></label>
                    <input type="text" id="securityAnswer" name="securityAnswer" placeholder="请输入答案" required>
                    <div class="error-message" id="securityError"></div>
                </div>
                <div class="button-group">
                    <button type="button" class="back-button" onclick="goToStep1()">上一步</button>
                    <button type="button" class="cancel-button" onclick="cancelReset()">取消</button>
                    <button type="submit" class="next-button">下一步</button>
                </div>
            </form>
        </div>
        
        <!-- 阶段3：密码重置 -->
        <div id="step3" class="step">
            <form id="reset-form" onsubmit="return validateResetPassword()">
                <div class="input-group">
                    <label for="newPassword">新密码<span class="required">*</span></label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="请输入新密码" required>
                    <div class="password-strength" id="passwordStrength"></div>
                    <div class="error-message" id="newPasswordError"></div>
                </div>
                <div class="input-group">
                    <label for="confirmPassword">确认新密码<span class="required">*</span></label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="请再次输入新密码" required>
                    <div class="error-message" id="confirmPasswordError"></div>
                </div>
                <div class="button-group">
                    <button type="button" class="back-button" onclick="goToStep2()">上一步</button>
                    <button type="button" class="cancel-button" onclick="cancelReset()">取消</button>
                    <button type="submit" class="reset-button">提交</button>
                </div>
            </form>
        </div>
        
        <!-- 成功提示 -->
        <div id="success-message" class="success-message">
            <h3>密码重置成功！</h3>
            <p>您的密码已成功重置，请使用新密码登录。</p>
            <button type="button" class="login-button" onclick="goToLogin()">返回登录</button>
        </div>
    </div>
</div>
```

### 3.2 前端JavaScript实现（forgot-password.js）

#### 3.2.1 核心功能
- 阶段切换逻辑
- 表单验证
- AJAX请求处理
- 密码强度检测
- 错误提示

#### 3.2.2 主要函数
```javascript
// 阶段切换函数
function goToStep1() { /* ... */ }
function goToStep2() { /* ... */ }
function goToStep3() { /* ... */ }

// 表单验证函数
function validateUsername() { /* ... */ }
function validateSecurityAnswer() { /* ... */ }
function validateResetPassword() { /* ... */ }

// AJAX请求函数
async function checkUsername() { /* ... */ }
async function verifySecurityAnswer() { /* ... */ }
async function resetPassword() { /* ... */ }

// 辅助函数
function showError() { /* ... */ }
function hideError() { /* ... */ }
function updatePasswordStrength() { /* ... */ }
```

### 3.3 后端API实现

#### 3.3.1 路由设计（userRoutes.js）
```javascript
// 密码找回相关路由
router.post('/forgot-password/verify-username', userController.verifyUsername);
router.post('/forgot-password/get-security-question', userController.getSecurityQuestion);
router.post('/forgot-password/verify-answer', userController.verifySecurityAnswer);
router.post('/forgot-password/reset', userController.resetPassword);
```

#### 3.3.2 控制器实现（userController.js）
```javascript
// 验证用户名是否存在
exports.verifyUsername = async (req, res) => { /* ... */ }

// 获取用户的安全问题
exports.getSecurityQuestion = async (req, res) => { /* ... */ }

// 验证安全问题答案
exports.verifySecurityAnswer = async (req, res) => { /* ... */ }

// 重置密码
exports.resetPassword = async (req, res) => { /* ... */ }
```

### 3.4 数据库操作（userModel.js）
```javascript
// 根据用户名查找用户
static async findUserByUsername(username) { /* ... */ }

// 验证安全问题答案
static async verifySecurityAnswer(username, answer) { /* ... */ }

// 更新用户密码
static async updatePassword(userId, newPassword) { /* ... */ }
```

### 3.5 登录页面修改（login.html）
```html
<!-- 修改忘记密码链接 -->
<a href="forgot-password.html" class="forgot-password">忘记密码?</a>
```

## 4. 安全考虑

1. **模糊错误提示**：所有验证失败统一显示模糊提示，不泄露具体错误原因
2. **bcrypt加密**：密码和安全答案使用bcrypt加密存储
3. **输入验证**：前端和后端双重验证，防止恶意输入
4. **CSRF保护**：添加CSRF令牌，防止跨站请求伪造
5. **会话管理**：使用安全的会话管理，防止会话劫持

## 5. 测试计划

1. **功能测试**：测试密码找回的完整流程
2. **安全性测试**：测试模糊错误提示、加密等安全措施
3. **响应式测试**：测试移动端适配
4. **边界测试**：测试各种边界情况，如不存在的用户名、错误的答案等

## 6. 预期效果

- 用户可以通过用户名和安全问题找回密码
- 所有验证失败都显示统一的模糊错误提示
- 密码重置过程安全可靠
- 页面美观，用户体验良好
- 适配各种设备

## 7. 实现步骤

1. 创建密码找回HTML页面
2. 实现前端JavaScript逻辑
3. 添加后端API路由
4. 实现后端控制器和模型
5. 更新登录页面链接
6. 测试功能完整性和安全性
7. 优化用户体验和响应式设计